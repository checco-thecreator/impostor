<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chi √® l'Impostore?</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&display=swap" rel="stylesheet">
    <style>
        :root{--primary-purple:#7B2CBF;--secondary-blue:#00A8E8;--hot-orange:#FF6B35;--accent-yellow:#F7B801;--bg-dark:#240046;--bg-light:#F4F4F9;--text-light:#FFFFFF;--font-main:'Lilita One',cursive;--danger-red:#E63946}
        @keyframes bg-pan{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        @keyframes glow{0%,100%{box-shadow:0 0 15px 5px var(--accent-yellow)}50%{box-shadow:0 0 25px 10px var(--accent-yellow)}}
        *{box-sizing:border-box;margin:0;padding:0}
        html, body { height: 100%; overflow: hidden; }
        body{font-family:var(--font-main);background:linear-gradient(-45deg,var(--primary-purple),var(--bg-dark),var(--secondary-blue));background-size:400% 400%;animation:bg-pan 15s ease infinite;display:flex;flex-direction: column;align-items:center;color:var(--text-light);}
        .container{width:100%;max-width:500px;padding:20px;display:flex;flex-direction:column;flex-grow: 1;overflow-y: auto;-webkit-overflow-scrolling: touch;}
        .screen{display:none;flex-direction:column;justify-content:center;align-items:center;text-align:center;width:100%;min-height: 100%;opacity:0;transition:opacity .5s ease-in-out,transform .5s ease-in-out;transform:scale(.95);}
        .screen.active{display:flex;opacity:1;transform:scale(1)}
        #game-screen { justify-content: space-between; }
        .game-top, .game-bottom { width: 100%; }
        h1{font-size:clamp(2.8rem, 12vw, 4.5rem);color:var(--accent-yellow)}
        .btn{ font-family:var(--font-main); font-size:clamp(1.5rem, 5vw, 1.8rem); padding:15px 25px; border-radius:50px; border:4px solid var(--bg-dark); box-shadow:0 8px 0 var(--bg-dark); cursor:pointer; transition:all .1s ease-in-out; width: 100%; max-width:320px; }
        .btn:active{transform:translateY(4px);box-shadow:0 4px 0 var(--bg-dark)}
        .card{background:rgba(0,0,0,.25);border-radius:20px;padding:15px;width:100%;margin-bottom:15px;border:2px solid rgba(255,255,255,.2)}
        input[type="text"]{font-family:var(--font-main);width:100%;padding:15px;border-radius:15px;border:none;font-size:clamp(1.2rem, 5vw, 1.5rem);background:var(--bg-light);color:var(--bg-dark);text-align:center}
        .avatar{width:100%;aspect-ratio:1/1;border-radius:50%;cursor:pointer;border:5px solid transparent;transition:all .2s;background:rgba(255,255,255,.1)}
        .avatar.selected{border-color:var(--accent-yellow);transform:scale(1.1)}
        #player-grid, #game-player-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:10px;width:100%;margin:15px 0}
        .player-card { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .player-card .avatar{border-color:var(--secondary-blue);margin-bottom:5px;width:80px;height:80px;}
        .player-card .nickname{font-size:1rem;background:var(--bg-dark);padding:2px 8px;border-radius:10px;word-break:break-word;}
        .player-card.is-turn .avatar{animation:glow 1.5s infinite}
        #clues-area{width:100%;flex-grow:1;background:rgba(0,0,0,.3);border-radius:15px;padding:10px;margin:15px 0;overflow-y:auto;display:flex;flex-direction:column-reverse;min-height: 150px; max-height: 40vh;}
        #clues-container { display: flex; flex-direction: column; }
        .clue{display:flex;align-items:center;margin-top:10px;background:rgba(0,0,0,.2);padding:5px 10px;border-radius:10px}
        .clue .avatar{width:30px;height:30px;margin-right:10px;border:none;flex-shrink:0}
        .clue-word{font-size:clamp(1.2rem, 5vw, 1.5rem);color:var(--accent-yellow); word-break: break-word;}
        #chat-input-area { display: flex; gap: 10px; width: 100%; max-width: 380px; margin-top: 15px; }
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);backdrop-filter:blur(5px);display:none;justify-content:center;align-items:center;z-index:1000}
        .modal.active{display:flex}
        .modal-content{background:linear-gradient(135deg,var(--hot-orange),var(--primary-purple));border-radius:25px;border:4px solid var(--bg-dark);padding:20px;text-align:center;width:100%;max-width:450px; max-height: 95vh; overflow-y: auto; display: flex; flex-direction: column; align-items: center;}
        .setting-row { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 10px; font-size: 1.2rem; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--secondary-blue); }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>
    <div class="container">
        <section id="home-screen" class="screen active">
            <h1>Chi √® l'Impostore?</h1>
            <p>üïµÔ∏è‚Äç‚ôÇÔ∏è Raduna i tuoi amici e scopri il bugiardo! üîç</p>
            <div class="card"><label for="nickname">Il tuo Nickname</label><input type="text" id="nickname" placeholder="CapitanMistero"></div>
            <div class="card"><label>Scegli il tuo Avatar</label><div class="avatar-grid" id="avatar-selection"></div></div>
            <div class="card">
                <div class="setting-row">
                    <span>Chat Libera</span>
                    <label class="switch">
                        <input type="checkbox" id="use-chat-checkbox" checked>
                        <span class="slider"></span>
                    </label>
                    <span>Gioco a Turni</span>
                </div>
            </div>
            <div class="button-group"> <button id="btn-create-lobby" class="btn">Crea Lobby</button> <button id="btn-join-lobby" class="btn">Unisciti</button> </div>
        </section>

        <section id="lobby-screen" class="screen">
            <h2>Lobby di <span id="host-name"></span></h2>
            <div class="card"><p>Codice Lobby:</p><h3 id="lobby-code">CODE</h3></div>
            <div id="player-grid"></div>
            <button id="btn-start-game" class="btn">Avvia Partita!</button>
        </section>

        <section id="game-screen" class="screen">
            <div class="game-top">
                <div id="game-player-grid"></div>
                <div class="card" id="word-card">
                    <p id="word-card-label"></p><h3 id="secret-word"></h3>
                    <p id="impostor-instructions" style="display:none;">Fai finta di conoscere la parola e non farti scoprire!</p>
                </div>
            </div>
            <div id="clues-area"><div id="clues-container"></div></div>
            <div class="game-bottom button-group">
                 <div id="chat-input-area" class="card"><input type="text" id="clue-input" placeholder="Scrivi un indizio..."><button id="btn-submit-clue" class="btn">Invia</button></div>
                 <div id="turn-indicator-card" class="card" style="display: none;"><h2>√à il turno di <span id="turn-player-name"></span></h2></div>
                 <button id="btn-pass-turn" class="btn" style="display:none;">Passa il Turno</button>
                 <button id="btn-call-vote" class="btn">Chiama la Votazione</button>
                 <button id="btn-impostor-guess" class="btn" style="display:none">üö® Tenta la Sorte! üö®</button>
            </div>
        </section>
    </div>
    
    <div id="vote-modal" class="modal"><div class="modal-content"><h2>üö® √à ORA DI VOTARE! üö®</h2><p>Chi pensi sia l'Impostore?</p><div id="vote-grid"></div></div></div>
    <div id="impostor-guess-modal" class="modal"><div class="modal-content"><h2>Tenta il tutto per tutto!</h2><input type="text" id="impostor-guess-input"><div class="button-group"><button id="btn-confirm-guess" class="btn">Conferma!</button><button class="btn-close-modal btn">Annulla</button></div></div></div>
    <div id="game-over-modal" class="modal"><div class="modal-content"><h2 id="game-over-title">PARTITA FINITA!</h2><div id="ejected-player-card" class="player-card"></div><p id="game-over-reason"></p><p>La parola era: <strong id="reveal-word"></strong></p><h3 id="game-over-winner"></h3><button id="btn-play-again" class="btn">Gioca Ancora</button></div></div>
    <div id="join-modal" class="modal"><div class="modal-content"><h2>Unisciti a una Lobby</h2><input type="text" id="join-code-input" placeholder="CODICE"><div class="button-group"><button id="btn-confirm-join" class="btn">Entra!</button><button class="btn-close-modal btn">Annulla</button></div></div></div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            let myState = { id: null, lobbyCode: null, isHost: false, avatar: 'avatar1.png', secretWord: '' };

            const screens = { home: document.getElementById('home-screen'), lobby: document.getElementById('lobby-screen'), game: document.getElementById('game-screen') };
            const modals = { vote: document.getElementById('vote-modal'), guess: document.getElementById('impostor-guess-modal'), over: document.getElementById('game-over-modal'), join: document.getElementById('join-modal') };
            const nicknameInput = document.getElementById('nickname');
            const avatarSelection = document.getElementById('avatar-selection');
            const showScreen = (screenName) => { Object.values(screens).forEach(s => s.classList.remove('active')); screens[screenName].classList.add('active'); };
            const showModal = (modalName) => { Object.values(modals).forEach(m => m.classList.remove('active')); modals[modalName].classList.add('active'); };
            document.querySelectorAll('.btn-close-modal').forEach(btn => btn.addEventListener('click', () => Object.values(modals).forEach(m => m.classList.remove('active'))));

            for (let i = 1; i <= 6; i++) {
                const img = document.createElement('img'); img.src = `/images/avatar${i}.png`; img.dataset.avatar = `avatar${i}.png`; img.classList.add('avatar'); if (i === 1) img.classList.add('selected');
                img.onclick = () => { avatarSelection.querySelector('.selected').classList.remove('selected'); img.classList.add('selected'); myState.avatar = img.dataset.avatar; };
                avatarSelection.appendChild(img);
            }

            function updateLobbyUI(state) {
                myState.lobbyCode = state.lobbyCode; myState.isHost = myState.id === state.hostId;
                document.getElementById('lobby-code').textContent = state.lobbyCode;
                document.getElementById('host-name').textContent = state.players.find(p => p.id === state.hostId)?.nickname || '...';
                const playerGrid = document.getElementById('player-grid'); playerGrid.innerHTML = '';
                state.players.forEach(p => { playerGrid.innerHTML += `<div class="player-card"><img src="/images/${p.avatar}" class="avatar"><span class="nickname">${p.nickname}</span></div>`; });
                document.getElementById('btn-start-game').style.display = myState.isHost ? 'block' : 'none';
                showScreen('lobby');
            }

            function updateGameUI(state) {
                const gamePlayerGrid = document.getElementById('game-player-grid'); gamePlayerGrid.innerHTML = '';
                state.players.forEach((p, i) => { gamePlayerGrid.innerHTML += `<div class="player-card ${state.turnIndex === i && !state.settings.useChat ? 'is-turn' : ''}"><img src="/images/${p.avatar}" class="avatar"><span class="nickname">${p.nickname}</span></div>`; });
                const cluesContainer = document.getElementById('clues-container'); cluesContainer.innerHTML = '';
                state.clues.forEach(clue => {
                    const player = state.players.find(p => p.id === clue.playerId);
                    if (player) cluesContainer.innerHTML += `<div class="clue"><img src="/images/${player.avatar}" class="avatar"><span class="clue-word">${clue.clue}</span></div>`;
                });

                // Gestione interfaccia basata sulla modalit√†
                const chatInputArea = document.getElementById('chat-input-area');
                const turnIndicatorCard = document.getElementById('turn-indicator-card');
                const passTurnBtn = document.getElementById('btn-pass-turn');
                
                chatInputArea.style.display = state.settings.useChat ? 'flex' : 'none';
                turnIndicatorCard.style.display = !state.settings.useChat ? 'block' : 'none';
                
                if (!state.settings.useChat) {
                    const turnPlayer = state.players[state.turnIndex];
                    document.getElementById('turn-player-name').textContent = turnPlayer.nickname;
                    passTurnBtn.style.display = turnPlayer.id === myState.id ? 'block' : 'none';
                }
            }

            document.getElementById('btn-create-lobby').addEventListener('click', () => { 
                if (!nicknameInput.value.trim()) return alert('Devi inserire un nickname!');
                socket.emit('createLobby', { nickname: nicknameInput.value.trim(), avatar: myState.avatar, settings: { useChat: document.getElementById('use-chat-checkbox').checked } }); 
            });
            document.getElementById('btn-join-lobby').addEventListener('click', () => { if (!nicknameInput.value.trim()) return alert('Devi inserire un nickname!'); showModal('join'); });
            document.getElementById('btn-confirm-join').addEventListener('click', () => { socket.emit('joinLobby', { lobbyCode: document.getElementById('join-code-input').value.trim().toUpperCase(), nickname: nicknameInput.value.trim(), avatar: myState.avatar }); });
            document.getElementById('btn-start-game').addEventListener('click', () => socket.emit('startGame', { lobbyCode: myState.lobbyCode }));
            document.getElementById('btn-submit-clue').addEventListener('click', () => {
                const clueInput = document.getElementById('clue-input');
                if (clueInput.value.trim()) socket.emit('submitClue', { lobbyCode: myState.lobbyCode, clue: clueInput.value.trim() });
                clueInput.value = '';
            });
            document.getElementById('btn-pass-turn').addEventListener('click', () => socket.emit('passTurn', { lobbyCode: myState.lobbyCode }));
            document.getElementById('btn-call-vote').addEventListener('click', () => socket.emit('callVote', { lobbyCode: myState.lobbyCode }));
            document.getElementById('btn-play-again').addEventListener('click', () => socket.emit('playAgain', { lobbyCode: myState.lobbyCode }));
            document.getElementById('btn-confirm-guess').addEventListener('click', () => socket.emit('impostorGuess', { lobbyCode: myState.lobbyCode, guess: document.getElementById('impostor-guess-input').value.trim() }));
            
            socket.on('connect', () => { myState.id = socket.id; });
            socket.on('lobbyUpdate', (state) => updateLobbyUI(state));
            socket.on('gameStarted', (state) => {
                myState.secretWord = state.word || '';
                const role = state.word ? 'player' : 'impostor';
                document.getElementById('word-card-label').textContent = role === 'player' ? "La tua parola segreta √®:" : "Il tuo ruolo √®:";
                document.getElementById('secret-word').textContent = role === 'player' ? state.word : "IMPOSTORE";
                document.getElementById('impostor-instructions').style.display = role === 'impostor' ? 'block' : 'none';
                document.getElementById('btn-impostor-guess').style.display = role === 'impostor' ? 'block' : 'none';
                showScreen('game');
            });
            socket.on('chatUpdate', (state) => updateGameUI(state));
            socket.on('turnUpdate', (state) => updateGameUI(state));
            socket.on('startVoting', (state) => {
                document.getElementById('chat-input-area').style.display = 'none';
                document.getElementById('turn-indicator-card').style.display = 'none';
                document.getElementById('btn-pass-turn').style.display = 'none';
                const voteGrid = document.getElementById('vote-grid'); voteGrid.innerHTML = '';
                state.players.forEach(p => {
                    if (p.id !== myState.id) {
                        const card = document.createElement('div'); card.className = 'player-card'; card.style.cursor = 'pointer';
                        card.innerHTML = `<img src="/images/${p.avatar}" class="avatar"><span class="nickname">${p.nickname}</span>`;
                        card.onclick = () => { voteGrid.innerHTML = `<h2>Hai votato per ${p.nickname}!</h2>`; socket.emit('playerVote', { lobbyCode: myState.lobbyCode, votedPlayerId: p.id }); };
                        voteGrid.appendChild(card);
                    }
                });
                showModal('vote');
            });
            socket.on('gameOver', ({ ejectedPlayer, wasImpostor, result, word }) => {
                document.getElementById('ejected-player-card').innerHTML = ejectedPlayer ? `<img src="/images/${ejectedPlayer.avatar}" class="avatar"><span class="nickname">${ejectedPlayer.nickname}</span>` : '';
                document.getElementById('game-over-reason').textContent = result.reason;
                document.getElementById('reveal-word').textContent = word;
                document.getElementById('game-over-winner').textContent = `VINCONO GLI ${result.winner.toUpperCase()}!`;
                document.getElementById('btn-play-again').style.display = myState.isHost ? 'block' : 'none';
                showModal('over');
            });
            socket.on('errorMsg', (e) => alert(`${e.title}\n${e.message}`));
        });
    </script>
</body>
</html>
