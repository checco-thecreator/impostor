<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Chi √® l'Impostore?</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&display=swap" rel="stylesheet">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7425121195660181" crossorigin="anonymous"></script>
    <style>
        :root{--primary-purple:#7B2CBF;--secondary-blue:#00A8E8;--hot-orange:#FF6B35;--accent-yellow:#F7B801;--bg-dark:#240046;--bg-light:#F4F4F9;--text-light:#FFFFFF;--font-main:'Lilita One',cursive;--danger-red:#E63946}
        @keyframes bg-pan{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        @keyframes pop-in{0%{transform:scale(.5);opacity:0}100%{transform:scale(1);opacity:1}}
        @keyframes fly-out{to{transform:translateY(-150%) rotate(45deg);opacity:0}}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
        *{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%;overflow:hidden}
        body{font-family:var(--font-main);background:linear-gradient(-45deg,var(--primary-purple),var(--bg-dark),var(--secondary-blue));background-size:400% 400%;animation:bg-pan 15s ease infinite;display:flex;justify-content:center;align-items:center;color:var(--text-light)}
        .container{width:100%;height:100%;max-width:500px;padding:20px;display:flex;flex-direction:column;position:relative}
        .screen{display:none;flex-direction:column;align-items:center;text-align:center;position:absolute;top:0;left:0;width:100%;height:100%;padding:20px;opacity:0;transition:opacity .5s,transform .5s;transform:scale(.95);overflow-y:auto;padding-bottom:80px}
        .screen.active{display:flex;opacity:1;transform:scale(1)}
        #home-screen{justify-content:space-around}
        #lobby-screen,#game-screen{justify-content:flex-start;padding-top:40px}
        h1{font-size:clamp(3rem,12vw,5rem);color:var(--accent-yellow);text-shadow:3px 3px 0 var(--bg-dark)}
        h2{font-size:clamp(2rem,8vw,3rem);color:var(--text-light);text-shadow:2px 2px 0 var(--bg-dark)}
        p{font-size:clamp(1rem,4vw,1.2rem);color:#ddd}
        .btn{font-family:var(--font-main);font-size:clamp(1.5rem,6vw,1.8rem);padding:15px 25px;border-radius:50px;border:4px solid var(--bg-dark);box-shadow:0 8px 0 var(--bg-dark);cursor:pointer;transition:all .1s ease-in-out;margin-top:15px;width:100%;max-width:350px}
        .btn:active{transform:translateY(4px);box-shadow:0 4px 0 var(--bg-dark)}
        .btn-primary{background-color:var(--hot-orange);color:var(--text-light)}
        .btn-secondary{background-color:var(--secondary-blue);color:var(--text-light)}
        .btn-danger{background-color:var(--danger-red);color:var(--text-light);font-size:1.2rem;padding:10px 20px}
        .card{background:rgba(0,0,0,.25);border-radius:20px;padding:clamp(10px,4vw,20px);width:100%;margin-bottom:15px;border:2px solid rgba(255,255,255,.2)}
        input{font-family:var(--font-main);width:100%;padding:15px;border-radius:15px;border:none;font-size:clamp(1.2rem,5vw,1.5rem);background:var(--bg-light);color:var(--bg-dark);text-align:center}
        .avatar-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .avatar{width:100%;aspect-ratio:1/1;border-radius:50%;cursor:pointer;border:5px solid transparent;transition:all .2s;background:rgba(255,255,255,.1)}
        .avatar.selected{border-color:var(--accent-yellow);transform:scale(1.1)}
        #player-grid,#game-player-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:10px;width:100%;margin:15px 0}
        .player-card{text-align:center;transition:opacity .3s,filter .3s,transform .3s}
        .player-card .avatar{border-color:var(--secondary-blue);margin-bottom:5px}
        .player-card .nickname{font-size:clamp(.9rem,3vw,1.2rem);background:var(--bg-dark);padding:2px 8px;border-radius:10px}
        .player-card.is-turn .avatar{animation:glow 1.5s infinite}
        .player-card.is-ejected{opacity:.4;filter:grayscale(1);transform:scale(.9)}
        #game-screen{display:flex;flex-direction:column;height:100%}
        #game-screen>*{flex-shrink:0}
        #clues-area{width:100%;flex-grow:1;background:rgba(0,0,0,.3);border-radius:15px;padding:15px;margin:15px 0;overflow-y:auto;display:flex;flex-direction:column-reverse;min-height:150px}
        #clues-container{display:flex;flex-direction:column}
        .clue{display:flex;align-items:center;margin-top:10px;background:rgba(0,0,0,.2);padding:5px 10px;border-radius:10px;animation:pop-in .3s}
        .clue .avatar{width:30px;height:30px;margin-right:10px;border:none;flex-shrink:0}
        .clue-word{font-size:1.5rem;color:var(--accent-yellow)}
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);backdrop-filter:blur(5px);display:none;justify-content:center;align-items:center;z-index:1000;opacity:0;transition:opacity .3s;padding:15px}
        .modal.active{display:flex;opacity:1}
        .modal-content{background:linear-gradient(135deg,var(--hot-orange),var(--primary-purple));border-radius:25px;border:4px solid var(--bg-dark);padding:30px;text-align:center;width:90%;max-width:450px;animation:pop-in .4s cubic-bezier(.17,.67,.6,1.44)}
        #vote-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px}
        #vote-grid .player-card{cursor:pointer;transition:transform .2s}
        #vote-grid .player-card:hover{transform:scale(1.05)}
        .vote-display{display:flex;flex-wrap:wrap;justify-content:center;gap:5px;margin-top:5px;min-height:25px}
        .vote-line{display:flex;align-items:center;background:rgba(0,0,0,.3);padding:2px 5px;border-radius:10px;animation:pop-in .3s}
        .vote-line .voter-avatar{width:20px;height:20px;border-radius:50%}
        #mute-btn{position:fixed;top:15px;right:15px;background:var(--primary-purple);color:var(--text-light);border:2px solid var(--text-light);width:50px;height:50px;border-radius:50%;z-index:2000;font-size:1.5rem}
        .footer-credits{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:.8rem;opacity:.6;pointer-events:none}
        .final-roles-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; text-align: left; }
    </style>
</head>
<body>
    <button id="mute-btn">üéµ</button>
    <div class="container">
        <section id="home-screen" class="screen active"></section>
        <section id="lobby-screen" class="screen"></section>
        <section id="game-screen" class="screen"></section>
    </div>
    <div id="main-modal" class="modal"></div>
    <footer class="footer-credits">Creato con ‚ù§Ô∏è da Checco</footer>
    <script src="/socket.io/socket.io.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        let myState = { id: null, lobbyCode: null, isHost: false, avatar: 'avatar1.png', secretWord: '' };
        
        const music = new Audio('/sounds/music.mp3'); music.loop = true;
        const sounds = {};
        ['join','start','turn','vote','win','lose','tick'].forEach(name => sounds[name] = new Audio(`/sounds/${name}.mp3`));
        let isMuted = false;
        
        const muteBtn = document.getElementById('mute-btn');
        muteBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            muteBtn.textContent = isMuted ? 'üîá' : 'üéµ';
            music.muted = isMuted;
        });
        const playSound = (name) => { if (!isMuted) sounds[name]?.play().catch(e => {}); };

        const showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId)?.classList.add('active');
        };
        const showModal = (content) => {
            const modal = document.getElementById('main-modal');
            modal.innerHTML = content;
            modal.classList.add('active');
            modal.querySelectorAll('.btn-close-modal').forEach(btn => btn.onclick = hideModals);
        };
        const hideModals = () => document.getElementById('main-modal').classList.remove('active');

        function renderHomeScreen() {
            const screen = document.getElementById('home-screen');
            screen.innerHTML = `
                <h1>Chi √®<br>l'Impostore?</h1>
                <p>üïµÔ∏è‚Äç‚ôÇÔ∏è Raduna i tuoi amici e scopri il bugiardo! üîç</p>
                <div style="width:100%;">
                    <div class="card"><label for="nickname" style="text-align:center;font-size:1.5rem;margin-bottom:10px">Il tuo Nickname</label><input type="text" id="nickname" placeholder="CapitanMistero"></div>
                    <div class="card"><label style="text-align:center;font-size:1.5rem;margin-bottom:10px">Scegli il tuo Avatar</label><div id="avatar-selection" class="avatar-grid"></div></div>
                </div>
                <div style="width:100%;">
                    <button id="btn-create-lobby" class="btn btn-primary">Crea Lobby</button>
                    <button id="btn-join-lobby" class="btn btn-secondary">Unisciti</button>
                </div>`;
            
            const avatarSelection = screen.querySelector('#avatar-selection');
            for (let i = 1; i <= 6; i++) {
                const img = document.createElement('img');
                img.src = `/images/avatar${i}.png`;
                img.dataset.avatar = `avatar${i}.png`;
                img.classList.add('avatar');
                if (i === 1) img.classList.add('selected');
                img.onclick = () => {
                    avatarSelection.querySelectorAll('.avatar').forEach(a => a.classList.remove('selected'));
                    img.classList.add('selected');
                    myState.avatar = img.dataset.avatar;
                };
                avatarSelection.appendChild(img);
            }
            
            screen.querySelector('#btn-create-lobby').onclick = () => {
                const nickname = screen.querySelector('#nickname').value.trim();
                if (!nickname) return alert('Devi inserire un nickname!');
                socket.emit('createLobby', { nickname, avatar: myState.avatar });
            };
            screen.querySelector('#btn-join-lobby').onclick = () => {
                const nickname = screen.querySelector('#nickname').value.trim();
                if (!nickname) return alert('Devi inserire un nickname!');
                showModal(`
                    <div class="modal-content">
                        <h2>Unisciti a una Lobby</h2>
                        <input type="text" id="join-code-input" placeholder="INSERISCI CODICE" maxlength="4" style="text-transform:uppercase">
                        <button id="btn-confirm-join" class="btn btn-primary">Entra!</button>
                        <button class="btn-close-modal btn-secondary">Annulla</button>
                    </div>`);
                document.getElementById('btn-confirm-join').onclick = () => {
                    const code = document.getElementById('join-code-input').value.trim().toUpperCase();
                    if (code.length === 4) socket.emit('joinLobby', { lobbyCode: code, nickname, avatar: myState.avatar });
                };
            };
        }

        function renderLobby(state) {
            myState.lobbyCode = state.lobbyCode;
            myState.isHost = myState.id === state.hostId;
            const screen = document.getElementById('lobby-screen');
            let playersHtml = '';
            state.players.forEach(p => { playersHtml += `<div class="player-card"><img src="/images/${p.avatar}" class="avatar"><span class="nickname">${p.nickname}</span></div>`; });
            screen.innerHTML = `
                <h2>Lobby di <span>${state.players.find(p => p.id === state.hostId)?.nickname || '...'}</span></h2>
                <div class="card"><p>Codice Lobby:</p><h3 style="font-size:3rem;color:var(--accent-yellow);cursor:pointer">${state.lobbyCode}</h3></div>
                <div id="player-grid">${playersHtml}</div>
                <button id="btn-start-game" class="btn btn-primary" style="display:${myState.isHost ? 'block' : 'none'}">Avvia Partita!</button>`;
            screen.querySelector('#btn-start-game').onclick = () => socket.emit('startGame', { lobbyCode: myState.lobbyCode });
            showScreen('lobby-screen');
        }

        function renderGame(state) {
            const screen = document.getElementById('game-screen');
            let playersHtml = '';
            const turnPlayerId = state.turnPlayerId;
            state.players.forEach(p => {
                playersHtml += `<div class="player-card ${p.id === turnPlayerId ? 'is-turn' : ''} ${p.isEjected ? 'is-ejected' : ''}">
                    <img src="/images/${p.avatar}" class="avatar">
                    <span class="nickname">${p.nickname}</span>
                </div>`;
            });
            let cluesHtml = '';
            state.clues.forEach(clue => {
                const player = state.players.find(p => p.id === clue.playerId);
                cluesHtml += `<div class="clue"><img src="/images/${player.avatar}" class="avatar"><span class="clue-word">${clue.clue}</span></div>`;
            });

            const isMyTurn = myState.id === turnPlayerId;
            if (isMyTurn) playSound('turn');

            screen.innerHTML = `
                <div id="game-player-grid">${playersHtml}</div>
                <div class="card" id="word-card" style="display: ${myState.secretWord ? 'block' : 'none'};"><p>La tua parola segreta √®:</p><h3 style="font-size:2.5rem;color:var(--accent-yellow)">${myState.secretWord}</h3></div>
                <div id="clues-area"><div id="clues-container">${cluesHtml}</div></div>
                <div class="card" id="clue-input-area" style="display: ${isMyTurn ? 'block' : 'none'}"><input type="text" id="clue-input" placeholder="Scrivi un indizio..."><button id="btn-submit-clue" class="btn btn-secondary">Invia Indizio</button></div>
                <button id="btn-impostor-guess" class="btn btn-danger" style="display: ${myState.isImpostor ? 'block' : 'none'}">üö® Tenta la Sorte! üö®</button>`;

            screen.querySelector('#btn-submit-clue')?.addEventListener('click', () => { /*...*/ });
            screen.querySelector('#btn-impostor-guess')?.addEventListener('click', () => { /*...*/ });
        }
        
        socket.on('lobbyUpdate', (state) => { playSound('join'); renderLobby(state); hideModals(); });
        socket.on('gameStarted', ({role, word}) => {
            playSound('start'); if (!isMuted) music.play();
            myState.secretWord = word; myState.isImpostor = role === 'impostor';
            showScreen('game-screen');
        });
        socket.on('turnUpdate', (state) => renderGame(state));
        // ... (molti altri handler per il gioco)

        // Init
        renderHomeScreen();
        showScreen('home-screen');
    });
    </script>
</body>
</html>