<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor Word</title>
    <style>
        /* CSS (molto espanso) */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root{--color-primary:#8e44ad;--color-secondary:#9b59b6;--color-text:#333;--color-light:#f9f9f9;--color-white:#ffffff;--border-radius:12px;--box-shadow:0 4px 15px rgba(0,0,0,0.1)}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Poppins',sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;background-color:#a0c4ff;color:var(--color-text);transition:background-color .5s ease}
        .container{width:90%;max-width:450px;background-color:var(--color-white);padding:30px 40px;border-radius:var(--border-radius);box-shadow:var(--box-shadow);text-align:center;position:relative}
        .screen{display:none;opacity:0;transition:opacity .4s ease-in-out}.screen.active{display:block;opacity:1}
        h1{font-size:2.5rem;color:var(--color-primary);margin-bottom:20px}h2{font-size:1.8rem;color:var(--color-secondary);margin-bottom:25px}h3{margin-bottom:15px;color:#555}p{margin-bottom:15px}
        button{font-family:'Poppins',sans-serif;font-size:1rem;font-weight:600;padding:12px 20px;border-radius:var(--border-radius);border:none;cursor:pointer;width:100%;margin-top:10px;transition:transform .2s,background-color .2s}
        button:hover:not(:disabled){transform:translateY(-2px)}button:disabled{background-color:#ccc;cursor:not-allowed}
        .btn-primary{background-color:var(--color-primary);color:var(--color-white)}.btn-primary:hover:not(:disabled){background-color:#7d3c98}
        .btn-secondary{background-color:var(--color-light);color:var(--color-primary);border:2px solid var(--color-primary)}.btn-secondary:hover:not(:disabled){background-color:#f1e4f7}
        .form-group{margin-bottom:15px;text-align:left}label{display:block;margin-bottom:5px;font-weight:600}
        input[type=text],select{width:100%;padding:12px;border:2px solid #ddd;border-radius:var(--border-radius);font-size:1rem}input:focus,select:focus{outline:none;border-color:var(--color-primary)}
        .card{background-color:var(--color-light);padding:20px;border-radius:var(--border-radius);margin-bottom:20px}
        /* Avatars */
        .avatar-selection{display:flex;justify-content:center;gap:10px;margin-bottom:15px}
        .avatar{width:50px;height:50px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:border-color .2s}
        .avatar.selected{border-color:var(--color-primary)}
        /* Player List */
        #player-list{list-style:none;padding:0;margin-bottom:25px;text-align:left}
        #player-list li{background-color:var(--color-light);padding:10px;margin-bottom:8px;border-radius:8px;font-weight:600;display:flex;align-items:center}
        #player-list .player-avatar{width:30px;height:30px;margin-right:10px}
        /* Gameplay Screen */
        #timer-display{font-size:2rem;font-weight:700;color:var(--color-primary);margin:20px 0}
        .role-card{background-color:#f3e5f5;border:2px dashed var(--color-primary);padding:20px;border-radius:var(--border-radius);min-height:150px;display:flex;flex-direction:column;justify-content:center;align-items:center}
        .secret-word{font-size:2.5rem;font-weight:700;color:var(--color-primary);margin:10px 0}
        /* Modal Styles */
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:100}
        .modal.active{display:flex}
        .modal-content{background:var(--color-white);padding:30px;border-radius:var(--border-radius);text-align:center;max-width:90%;width:400px}
        .vote-options button{margin-bottom:10px}
    </style>
</head>
<body>

    <div class="container">
        <!-- Schermata Iniziale -->
        <div id="home-screen" class="screen active">
            <h1>Impostor Word</h1>
            <p>Raduna i tuoi amici e scopri chi è l'impostore!</p>
            <button id="btn-go-to-play" class="btn-primary">Gioca</button>
            <button id="btn-how-to-play" class="btn-secondary">Come si Gioca</button>
        </div>

        <!-- Schermata Gioca (Crea/Entra) -->
        <div id="play-screen" class="screen">
            <h2>Entra in Partita</h2>
            <div class="card">
                <h3>Scegli il tuo Avatar</h3>
                <div id="avatar-selection-create" class="avatar-selection"></div>
            </div>
            <div class="card">
                <h3>Crea una nuova Lobby</h3>
                <div class="form-group"><input type="text" id="create-nickname" placeholder="Il tuo Nickname"></div>
                <div class="form-group"><label for="num-players">Numero Max Giocatori</label><select id="num-players"><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
                <div class="form-group"><label for="num-impostors">Numero Impostori</label><select id="num-impostors"><option value="1" selected>1</option><option value="2">2</option></select></div>
                <button id="btn-create-lobby" class="btn-primary">Crea</button>
            </div>
            <div class="card">
                <h3>Entra in una Lobby</h3>
                <div id="avatar-selection-join" class="avatar-selection"></div>
                <div class="form-group"><input type="text" id="join-code" placeholder="Codice Lobby"></div>
                <div class="form-group"><input type="text" id="join-nickname" placeholder="Il tuo Nickname"></div>
                <button id="btn-join-lobby" class="btn-secondary">Entra</button>
            </div>
        </div>

        <!-- Schermata Lobby -->
        <div id="lobby-screen" class="screen">
            <h2>Lobby: <span id="lobby-code-display"></span></h2>
            <p>Condividi questo codice con i tuoi amici!</p>
            <h3>Giocatori Connessi</h3><ul id="player-list"></ul>
            <button id="btn-start-game" class="btn-primary">Inizia Partita</button>
        </div>
        
        <!-- Schermata di Gioco -->
        <div id="gameplay-screen" class="screen">
            <h2 id="game-word-display">La parola è: ???</h2>
            <div id="timer-display">02:00</div>
            <div id="role-info" class="role-card"></div>
            <div id="host-controls">
                <button id="btn-start-timer" class="btn-secondary">Avvia Timer</button>
                <button id="btn-start-voting" class="btn-primary">Inizia Votazione</button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="how-to-play-modal" class="modal">
        <div class="modal-content">
            <h2>Come si Gioca</h2>
            <p>1. Un giocatore crea una lobby e condivide il codice.</p>
            <p>2. Gli altri si uniscono con il codice e un nickname.</p>
            <p>3. Tutti ricevono la stessa parola, tranne l'Impostore!</p>
            <p>4. A turno, ogni giocatore dice UNA parola per descrivere la parola segreta.</p>
            <p>5. L'impostore deve fingere e provare a indovinare la parola segreta.</p>
            <p>6. Dopo la discussione, votate per eliminare chi pensate sia l'impostore!</p>
            <button id="btn-close-how-to-play" class="btn-primary">Ho Capito!</button>
        </div>
    </div>
    
    <div id="voting-modal" class="modal">
        <div class="modal-content">
            <h2>Chi è l'Impostore?</h2>
            <p>Vota per eliminare un giocatore.</p>
            <div id="vote-options" class="vote-options"></div>
        </div>
    </div>

    <div id="game-over-modal" class="modal">
        <div class="modal-content">
            <h2 id="game-over-title">Partita Finita!</h2>
            <p id="game-over-ejected"></p>
            <p id="game-over-role"></p>
            <p id="game-over-word">La parola era: <strong id="reveal-word"></strong></p>
            <h3 id="game-over-winner"></h3>
            <button id="btn-play-again" class="btn-primary">Gioca Ancora</button>
            <button id="btn-return-home" class="btn-secondary">Torna alla Home</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        let currentLobbyCode = null;
        let myId = null;
        let selectedAvatar = 'avatar1.png';

        // --- Audio Setup ---
        const sounds = {
            join: new Audio('/sounds/join.mp3'),
            start: new Audio('/sounds/start.mp3'),
            vote: new Audio('/sounds/vote.mp3'),
            win: new Audio('/sounds/win.mp3'),
            lose: new Audio('/sounds/lose.mp3')
        };
        
        // --- DOM Elements ---
        const screens = document.querySelectorAll('.screen');
        const modals = document.querySelectorAll('.modal');
        const lobbyCodeDisplay = document.getElementById('lobby-code-display');
        const playerList = document.getElementById('player-list');
        const btnStartGame = document.getElementById('btn-start-game');
        
        // --- UI Functions ---
        const showScreen = (screenId) => {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId)?.classList.add('active');
        };
        const showModal = (modalId) => {
            modals.forEach(m => m.classList.remove('active'));
            document.getElementById(modalId)?.classList.add('active');
        };
        const hideModals = () => modals.forEach(m => m.classList.remove('active'));

        const createAvatarSelection = (containerId) => {
            const container = document.getElementById(containerId);
            for (let i = 1; i <= 6; i++) {
                const avatarImg = document.createElement('img');
                avatarImg.src = `/images/avatar${i}.png`;
                avatarImg.classList.add('avatar');
                if (i === 1) avatarImg.classList.add('selected');
                avatarImg.dataset.avatar = `avatar${i}.png`;
                avatarImg.addEventListener('click', (e) => {
                    document.querySelectorAll(`#${containerId} .avatar`).forEach(a => a.classList.remove('selected'));
                    e.target.classList.add('selected');
                    selectedAvatar = e.target.dataset.avatar;
                });
                container.appendChild(avatarImg);
            }
        };
        createAvatarSelection('avatar-selection-create');
        createAvatarSelection('avatar-selection-join');

        const updatePlayerList = (players) => {
            playerList.innerHTML = '';
            players.forEach(player => {
                const li = document.createElement('li');
                const img = document.createElement('img');
                img.src = `/images/${player.avatar}`;
                img.classList.add('player-avatar');
                li.appendChild(img);
                li.innerHTML += `<span>${player.nickname}</span>`;
                playerList.appendChild(li);
            });
        };
        
        // --- Event Listeners (Setup & Navigation) ---
        document.getElementById('btn-go-to-play').addEventListener('click', () => showScreen('play-screen'));
        document.getElementById('btn-how-to-play').addEventListener('click', () => showModal('how-to-play-modal'));
        document.getElementById('btn-close-how-to-play').addEventListener('click', hideModals);
        document.getElementById('btn-return-home').addEventListener('click', () => location.reload());

        // --- Socket Emits (Client Actions) ---
        document.getElementById('btn-create-lobby').addEventListener('click', () => {
            const nickname = document.getElementById('create-nickname').value.trim();
            if (nickname) {
                const data = {
                    nickname,
                    avatar: selectedAvatar,
                    numPlayers: document.getElementById('num-players').value,
                    numImpostors: document.getElementById('num-impostors').value
                };
                socket.emit('createLobby', data);
            }
        });

        document.getElementById('btn-join-lobby').addEventListener('click', () => {
            const nickname = document.getElementById('join-nickname').value.trim();
            const lobbyCode = document.getElementById('join-code').value.trim().toUpperCase();
            if (nickname && lobbyCode) {
                socket.emit('joinLobby', { lobbyCode, nickname, avatar: selectedAvatar });
            }
        });

        btnStartGame.addEventListener('click', () => socket.emit('startGame', { lobbyCode: currentLobbyCode }));
        document.getElementById('btn-start-timer').addEventListener('click', () => socket.emit('startTimer', { lobbyCode: currentLobbyCode }));
        document.getElementById('btn-start-voting').addEventListener('click', () => socket.emit('startVoting', { lobbyCode: currentLobbyCode }));
        document.getElementById('btn-play-again').addEventListener('click', () => socket.emit('playAgain', { lobbyCode: currentLobbyCode }));

        // --- Socket Handlers (Server Responses) ---
        socket.on('connect', () => { myId = socket.id; });

        socket.on('lobbyCreated', (data) => {
            sounds.join.play();
            currentLobbyCode = data.lobbyCode;
            lobbyCodeDisplay.textContent = data.lobbyCode;
            updatePlayerList(data.players);
            btnStartGame.style.display = 'block';
            showScreen('lobby-screen');
        });

        socket.on('lobbyUpdate', (data) => {
            sounds.join.play();
            updatePlayerList(data.players);
            btnStartGame.style.display = (data.hostId === myId) ? 'block' : 'none';
            if (!document.getElementById('lobby-screen').classList.contains('active')) {
                currentLobbyCode = data.lobbyCode;
                lobbyCodeDisplay.textContent = data.lobbyCode;
                showScreen('lobby-screen');
            }
            // Torna alla lobby se siamo in una schermata di fine partita
            if (document.getElementById('game-over-modal').classList.contains('active')) {
                hideModals();
                showScreen('lobby-screen');
            }
        });

        socket.on('gameStarted', (data) => {
            sounds.start.play();
            const roleInfo = document.getElementById('role-info');
            document.getElementById('host-controls').style.display = (btnStartGame.style.display === 'block') ? 'block' : 'none';
            
            if (data.role === 'impostor') {
                document.getElementById('game-word-display').style.display = 'none';
                roleInfo.innerHTML = `<h3>Sei l'Impostore!</h3><p>Cerca di indovinare la parola segreta!</p>`;
            } else {
                document.getElementById('game-word-display').style.display = 'block';
                document.getElementById('game-word-display').textContent = `La parola è: ${data.word}`;
                roleInfo.innerHTML = `<h3>Sei un Innocente</h3><p>Descrivi la parola senza nominarla.</p>`;
            }
            showScreen('gameplay-screen');
        });

        socket.on('timerUpdate', (time) => {
            const minutes = Math.floor(time / 60).toString().padStart(2, '0');
            const seconds = (time % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').textContent = `${minutes}:${seconds}`;
        });

        socket.on('votingStarted', (players) => {
            sounds.vote.play();
            const voteOptions = document.getElementById('vote-options');
            voteOptions.innerHTML = '';
            players.forEach(player => {
                if (player.id !== myId) {
                    const button = document.createElement('button');
                    button.textContent = `Vota ${player.nickname}`;
                    button.classList.add('btn-secondary');
                    button.addEventListener('click', () => {
                        voteOptions.innerHTML = '<p>Hai votato! In attesa degli altri...</p>';
                        socket.emit('playerVote', { lobbyCode: currentLobbyCode, votedPlayerId: player.id });
                    });
                    voteOptions.appendChild(button);
                }
            });
            showModal('voting-modal');
        });

        socket.on('gameOver', (data) => {
            const { ejectedPlayer, wasImpostor, result, word } = data;
            
            if (result.winner === 'Innocenti') sounds.win.play(); else sounds.lose.play();

            document.getElementById('game-over-ejected').textContent = `Avete eliminato ${ejectedPlayer.nickname}.`;
            document.getElementById('game-over-role').textContent = wasImpostor ? "Era un impostore!" : "Non era un impostore.";
            document.getElementById('reveal-word').textContent = word;
            document.getElementById('game-over-winner').textContent = `Vincono gli ${result.winner}!`;
            document.getElementById('btn-play-again').style.display = (btnStartGame.style.display === 'block') ? 'block' : 'none';

            hideModals();
            showModal('game-over-modal');
        });

        socket.on('errorMsg', (message) => alert(message));
    });
    </script>
</body>
</html>